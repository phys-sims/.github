name: CI

on:
  workflow_call:
    inputs:
      python-versions:
        description: JSON list of Python versions for the matrix (e.g. ["3.11","3.12"])
        required: false
        default: '["3.11"]'   #["3.10","3.11","3.12"]
        type: string

      install-phys-pipeline:
        description: Checkout + pip install -e phys-pipeline before installing this repo
        required: false
        default: false
        type: boolean

      phys-pipeline-repo:
        description: Owner/repo for phys-pipeline
        required: false
        default: "phys-sims/phys-pipeline"
        type: string

      install-abcdef-sim:
        description: Checkout + pip install -e abcdef-sim before installing this repo
        required: false
        default: false
        type: boolean

      abcdef-sim-repo:
        description: Owner/repo for abcdef-sim
        required: false
        default: "phys-sims/abcdef-sim"
        type: string

jobs:
  build:
    name: build (${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJson(inputs.python-versions) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Checkout phys-pipeline
        if: ${{ inputs.install-phys-pipeline }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.phys-pipeline-repo }}
          path: phys-pipeline

      - name: Checkout abcdef-sim
        if: ${{ inputs.install-abcdef-sim }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.abcdef-sim-repo }}
          path: abcdef-sim

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Cache pre-commit envs
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('repo/.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Install dev deps (editable)
        working-directory: repo
        run: |
          python -m pip install --upgrade pip

          # Optional local editable installs for repo-to-repo dependencies.
          # These installs happen BEFORE installing the current repo.
          if [ "${{ inputs.install-phys-pipeline }}" = "true" ]; then
            pip install -e ../phys-pipeline
          fi
          if [ "${{ inputs.install-abcdef-sim }}" = "true" ]; then
            pip install -e ../abcdef-sim
          fi

          pip install -e .[dev]
          pip install pre-commit

      - name: Lint & hooks (pre-commit)
        working-directory: repo
        run: pre-commit run --all-files --show-diff-on-failure

      - name: Typecheck (mypy)
        working-directory: repo
        run: mypy # [tool.mypy] sets scope to src

      - name: Tests (fast)
        working-directory: repo
        run: pytest -q -m "not slow"

  gate:
    name: gate
    runs-on: ubuntu-latest
    needs: [build]             # waits for ALL matrix copies of 'build'
    steps:
      - run: echo "All matrix builds passed âœ…"
